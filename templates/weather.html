<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wetter Radar - Aviation Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', monospace;
            background: #000;
            color: #0ff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Animated Background */
        .bg-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
            z-index: 0;
        }

        @keyframes gridMove {
            0% { transform: translateY(0); }
            100% { transform: translateY(50px); }
        }

        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(transparent 50%, rgba(0, 255, 255, 0.03) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            animation: scan 8s linear infinite;
            z-index: 999;
        }

        @keyframes scan {
            0% { background-position: 0 0; }
            100% { background-position: 0 100%; }
        }

        .container {
            position: relative;
            z-index: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0.4rem;
            gap: 0.4rem;
        }

        header {
            text-align: center;
            padding: 0.3rem;
            background: rgba(0, 255, 255, 0.05);
            border: 2px solid #0ff;
            border-radius: 6px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        header h1 {
            font-size: 1rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 10px #0ff;
        }

        #map {
            flex: 1;
            width: 100%;
            border: 2px solid #0ff;
            border-radius: 6px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        nav {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.3rem;
        }

        nav button {
            padding: 0.5rem;
            font-family: 'Orbitron', monospace;
            font-size: 0.65rem;
            font-weight: 700;
            background: rgba(0, 255, 255, 0.1);
            color: #0ff;
            border: 2px solid #0ff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        nav button:hover {
            background: rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
            transform: translateY(-2px);
        }

        nav button:active {
            transform: translateY(0);
        }

        .legend {
            position: absolute;
            bottom: 80px;
            right: 10px;
            background: rgba(0, 20, 40, 0.95);
            border: 2px solid #0ff;
            padding: 0.8rem;
            border-radius: 6px;
            font-size: 0.7rem;
            z-index: 1000;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        .legend h3 {
            color: #0ff;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.3rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 0.5rem;
            border-radius: 4px;
            border: 1px solid #0ff;
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    <div class="scanline"></div>

    <div class="container">
        <header>
            <h1>üå¶ WETTER RADAR</h1>
        </header>

        <div id="map"></div>

        <div class="legend">
            <h3>NIEDERSCHLAG</h3>
            <div class="legend-item">
                <div class="legend-color" style="background: #0099ff;"></div>
                Leicht
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #00ff00;"></div>
                M√§√üig
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffff00;"></div>
                Stark
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff0000;"></div>
                Gewitter
            </div>
        </div>

        <nav>
            <button onclick="location.href='/'">HOME</button>
            <button onclick="location.href='/weather'">WETTER</button>
            <button onclick="location.href='/flights'">FL√úGE</button>
            <button onclick="location.reload()">REFRESH</button>
        </nav>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map with coordinates from Flask
        const homeLat = parseFloat("{{ lat }}");
        const homeLon = parseFloat("{{ lon }}");
        const map = L.map('map').setView([homeLat, homeLon], 9);

        // Dark base layer for better contrast
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap, ¬© CartoDB',
            maxZoom: 19
        }).addTo(map);

        // Custom home marker with cyan style
        const homeIcon = L.divIcon({
            html: '<div style="font-size: 24px; text-shadow: 0 0 10px #0ff;">üìç</div>',
            className: 'custom-marker',
            iconSize: [24, 24],
            iconAnchor: [12, 24]
        });

        L.marker([homeLat, homeLon], { icon: homeIcon }).addTo(map)
            .bindPopup('<b style="color: #0ff;">HOME BASE</b>')
            .openPopup();

        // RainViewer API for weather radar
        let radarLayer = null;

        async function loadRadarData() {
            try {
                const resp = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                const data = await resp.json();

                if (data.radar && data.radar.past.length > 0) {
                    const frames = data.radar.past;
                    const latestFrame = frames[frames.length - 1];

                    // Remove old layer
                    if (radarLayer) {
                        map.removeLayer(radarLayer);
                    }

                    // Add new radar layer
                    radarLayer = L.tileLayer(
                        `https://tilecache.rainviewer.com${latestFrame.path}/256/{z}/{x}/{y}/2/1_1.png`,
                        {
                            opacity: 0.7,
                            maxZoom: 19
                        }
                    ).addTo(map);

                    console.log('Radar updated:', new Date(latestFrame.time * 1000).toLocaleTimeString());
                }
            } catch (error) {
                console.error('Radar loading error:', error);
            }
        }

        // Load radar on startup
        loadRadarData();

        // Refresh every 5 minutes
        setInterval(loadRadarData, 300000);
    </script>
</body>
</html>