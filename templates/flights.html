<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Fl√ºge - Aviation Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', monospace;
            background: #000;
            color: #0ff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Animated Background */
        .bg-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
            z-index: 0;
        }

        @keyframes gridMove {
            0% { transform: translateY(0); }
            100% { transform: translateY(50px); }
        }

        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(transparent 50%, rgba(0, 255, 255, 0.03) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            animation: scan 8s linear infinite;
            z-index: 999;
        }

        @keyframes scan {
            0% { background-position: 0 0; }
            100% { background-position: 0 100%; }
        }

        .container {
            position: relative;
            z-index: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0.6rem;
            gap: 0.5rem;
        }

        header {
            text-align: center;
            padding: 0.4rem;
            background: rgba(0, 255, 255, 0.05);
            border: 2px solid #0ff;
            border-radius: 6px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3), inset 0 0 20px rgba(0, 255, 255, 0.1);
        }

        header h1 {
            font-size: 1.2rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px #0ff, 0 0 20px #0ff, 0 0 30px #0ff;
        }

        #map {
            flex: 1;
            width: 100%;
            border: 2px solid #0ff;
            border-radius: 6px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        nav {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.4rem;
        }

        nav button {
            padding: 0.6rem;
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            background: rgba(0, 255, 255, 0.1);
            color: #0ff;
            border: 2px solid #0ff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        nav button:hover {
            background: rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
            transform: translateY(-2px);
        }

        nav button:active {
            transform: translateY(0);
        }

        .info-box {
            position: absolute;
            top: 80px;
            right: 10px;
            background: rgba(0, 20, 40, 0.95);
            border: 2px solid #0ff;
            padding: 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
            min-width: 180px;
        }

        .info-box h3 {
            color: #0ff;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            font-size: 0.9rem;
            text-shadow: 0 0 10px #0ff;
        }

        .flight-count {
            font-size: 2.5rem;
            font-weight: 900;
            color: #0ff;
            text-align: center;
            margin: 0.5rem 0;
            text-shadow: 0 0 20px #0ff, 0 0 40px #0ff;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .info-detail {
            font-size: 0.65rem;
            text-align: center;
            opacity: 0.8;
            margin-top: 0.5rem;
        }

        /* Custom plane icon with rotation */
        .plane-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        .plane-icon svg {
            width: 24px;
            height: 24px;
            filter: drop-shadow(0 0 4px currentColor);
        }

        /* Altitude-based colors */
        .altitude-low { color: #ff3333; }      /* Red - below 1000m */
        .altitude-medium { color: #ffaa00; }   /* Orange - 1000-5000m */
        .altitude-high { color: #00ffff; }     /* Cyan - 5000-10000m */
        .altitude-cruise { color: #ff00ff; }   /* Magenta - above 10000m */

        /* Leaflet popup styling */
        .leaflet-popup-content-wrapper {
            background: rgba(0, 20, 40, 0.98);
            color: #0ff;
            border: 2px solid #0ff;
            border-radius: 6px;
            font-family: 'Orbitron', monospace;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .leaflet-popup-content {
            margin: 1rem;
            font-size: 0.75rem;
            min-width: 220px;
        }

        .leaflet-popup-tip {
            background: rgba(0, 20, 40, 0.98);
            border: 2px solid #0ff;
        }

        .popup-header {
            font-size: 1.1rem;
            font-weight: 900;
            color: #0ff;
            text-shadow: 0 0 10px #0ff;
            margin-bottom: 0.8rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(0, 255, 255, 0.3);
        }

        .popup-row {
            display: flex;
            justify-content: space-between;
            margin: 0.4rem 0;
            padding: 0.3rem 0;
        }

        .popup-label {
            color: rgba(0, 255, 255, 0.7);
            font-size: 0.7rem;
        }

        .popup-value {
            color: #0ff;
            font-weight: 700;
        }

        .status-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 700;
            margin-top: 0.5rem;
        }

        .status-climbing {
            background: rgba(0, 255, 100, 0.2);
            color: #0f0;
            border: 1px solid #0f0;
        }

        .status-descending {
            background: rgba(255, 100, 0, 0.2);
            color: #ff5500;
            border: 1px solid #ff5500;
        }

        .status-level {
            background: rgba(0, 255, 255, 0.2);
            color: #0ff;
            border: 1px solid #0ff;
        }

        .status-ground {
            background: rgba(128, 128, 128, 0.2);
            color: #888;
            border: 1px solid #888;
        }

        .alert-emergency {
            background: rgba(255, 0, 0, 0.3);
            color: #ff0000;
            border: 2px solid #ff0000;
            padding: 0.5rem;
            margin-top: 0.5rem;
            text-align: center;
            font-weight: 900;
            animation: emergency-blink 1s infinite;
        }

        @keyframes emergency-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    <div class="scanline"></div>

    <div class="container">
        <header>
            <h1>‚úà LIVE FLUGVERKEHR</h1>
        </header>

        <div id="map"></div>

        <div class="info-box">
            <h3>üõ© FLUGZEUGE</h3>
            <div class="flight-count" id="flight-count">0</div>
            <div class="info-detail">In der N√§he</div>
            <div class="info-detail" style="margin-top: 1rem;">Update: 30s</div>
        </div>

        <nav>
            <button onclick="location.href='/'">HOME</button>
            <button onclick="location.href='/weather'">WETTER</button>
            <button onclick="location.href='/flights'">FL√úGE</button>
            <button onclick="updateFlights()">REFRESH</button>
        </nav>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map with coordinates from Flask (fallback to example coords)
        const homeLat = 51.9066; // Example: G√ºtersloh
        const homeLon = 8.3853;
        const map = L.map('map').setView([homeLat, homeLon], 8);

        // Dark base layer for better contrast
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap, ¬© CartoDB',
            maxZoom: 19
        }).addTo(map);

        // Custom home marker
        const homeIcon = L.divIcon({
            html: '<div style="font-size: 28px; text-shadow: 0 0 10px #0ff;">üìç</div>',
            className: 'custom-marker',
            iconSize: [28, 28],
            iconAnchor: [14, 28]
        });

        L.marker([homeLat, homeLon], { icon: homeIcon }).addTo(map)
            .bindPopup('<b style="color: #0ff;">HOME BASE</b>');

        // Store plane markers
        let planeMarkers = {};

        // Function to get altitude-based color class
        function getAltitudeClass(altitude) {
            if (altitude < 1000) return 'altitude-low';
            if (altitude < 5000) return 'altitude-medium';
            if (altitude < 10000) return 'altitude-high';
            return 'altitude-cruise';
        }

        // Function to create plane icon with rotation and color
        function createPlaneIcon(heading, altitude) {
            const colorClass = getAltitudeClass(altitude);
            const rotation = heading || 0;

            return L.divIcon({
                html: `
                    <div class="plane-icon ${colorClass}" style="transform: rotate(${rotation}deg);">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21,16v-2l-8-5V3.5C13,2.67,12.33,2,11.5,2S10,2.67,10,3.5V9l-8,5v2l8-2.5V19l-2,1.5V22l3.5-1l3.5,1v-1.5L13,19v-5.5L21,16z"/>
                        </svg>
                    </div>
                `,
                className: 'custom-plane-icon',
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });
        }

        // Function to get flight status
        function getFlightStatus(onGround, verticalRate) {
            if (onGround) return { text: 'üÖøÔ∏è AM BODEN', class: 'status-ground' };
            if (verticalRate > 1) return { text: 'üî∫ STEIGFLUG', class: 'status-climbing' };
            if (verticalRate < -1) return { text: 'üîª LANDEANFLUG', class: 'status-descending' };
            return { text: '‚û°Ô∏è REISEFLUG', class: 'status-level' };
        }

        // Function to check emergency squawk codes
        function checkEmergency(squawk) {
            if (squawk === '7500') return 'üö® HIJACK ALERT';
            if (squawk === '7600') return 'üì° FUNKAUSFALL';
            if (squawk === '7700') return 'üÜò NOTFALL';
            return null;
        }

        // Function to format time since last contact
        function getDataAge(lastContact) {
            const age = Math.floor(Date.now() / 1000 - lastContact);
            if (age < 60) return `${age}s`;
            if (age < 3600) return `${Math.floor(age / 60)}min`;
            return `${Math.floor(age / 3600)}h`;
        }

        // Fetch flights from OpenSky Network API
        async function updateFlights() {
            try {
                // Define bounding box (approximately 150km around home)
                const latDelta = 1.5;
                const lonDelta = 2.0;

                const bbox = `lamin=${homeLat-latDelta}&lomin=${homeLon-lonDelta}&lamax=${homeLat+latDelta}&lomax=${homeLon+lonDelta}`;
                const url = `https://opensky-network.org/api/states/all?${bbox}`;

                const resp = await fetch(url);
                const data = await resp.json();

                if (data.states) {
                    // Clear old markers
                    Object.values(planeMarkers).forEach(marker => map.removeLayer(marker));
                    planeMarkers = {};

                    let count = 0;

                    data.states.forEach(state => {
                        const [
                            icao24,           // 0
                            callsign,         // 1
                            country,          // 2
                            timePosition,     // 3
                            lastContact,      // 4
                            lon,              // 5
                            lat,              // 6
                            baroAltitude,     // 7
                            onGround,         // 8
                            velocity,         // 9
                            trueTrack,        // 10
                            verticalRate,     // 11
                            sensors,          // 12
                            geoAltitude,      // 13
                            squawk,           // 14
                            spi,              // 15
                            positionSource    // 16
                        ] = state;

                        if (lat && lon) {
                            count++;

                            const altitude = baroAltitude || geoAltitude || 0;
                            const heading = trueTrack || 0;
                            const speed = velocity ? Math.round(velocity * 3.6) : 0;
                            const vRate = verticalRate || 0;
                            const dataAge = lastContact ? getDataAge(lastContact) : 'N/A';
                            const flightStatus = getFlightStatus(onGround, vRate);
                            const emergency = squawk ? checkEmergency(squawk) : null;

                            // Create icon with rotation and color
                            const icon = createPlaneIcon(heading, altitude);

                            // Create detailed popup
                            let popupContent = `
                                <div>
                                    <div class="popup-header">
                                        ${callsign ? callsign.trim() : icao24.toUpperCase()}
                                    </div>

                                    <div class="popup-row">
                                        <span class="popup-label">Land:</span>
                                        <span class="popup-value">${country || 'Unknown'}</span>
                                    </div>

                                    <div class="popup-row">
                                        <span class="popup-label">ICAO24:</span>
                                        <span class="popup-value">${icao24.toUpperCase()}</span>
                                    </div>

                                    <div class="popup-row">
                                        <span class="popup-label">H√∂he:</span>
                                        <span class="popup-value">${altitude ? Math.round(altitude) + 'm' : 'N/A'}</span>
                                    </div>

                                    <div class="popup-row">
                                        <span class="popup-label">Speed:</span>
                                        <span class="popup-value">${speed} km/h</span>
                                    </div>

                                    <div class="popup-row">
                                        <span class="popup-label">Kurs:</span>
                                        <span class="popup-value">${Math.round(heading)}¬∞</span>
                                    </div>

                                    <div class="popup-row">
                                        <span class="popup-label">Vertikalrate:</span>
                                        <span class="popup-value">${vRate > 0 ? '+' : ''}${vRate.toFixed(1)} m/s</span>
                                    </div>
                            `;

                            if (squawk) {
                                popupContent += `
                                    <div class="popup-row">
                                        <span class="popup-label">Squawk:</span>
                                        <span class="popup-value">${squawk}</span>
                                    </div>
                                `;
                            }

                            popupContent += `
                                    <div class="popup-row">
                                        <span class="popup-label">Datenalter:</span>
                                        <span class="popup-value">${dataAge}</span>
                                    </div>

                                    <div style="text-align: center;">
                                        <span class="status-badge ${flightStatus.class}">${flightStatus.text}</span>
                                    </div>
                            `;

                            if (emergency) {
                                popupContent += `
                                    <div class="alert-emergency">
                                        ${emergency}
                                    </div>
                                `;
                            }

                            popupContent += '</div>';

                            // Add marker
                            const marker = L.marker([lat, lon], { icon: icon })
                                .addTo(map)
                                .bindPopup(popupContent);

                            planeMarkers[icao24] = marker;
                        }
                    });

                    // Update flight count
                    document.getElementById('flight-count').textContent = count;
                } else {
                    document.getElementById('flight-count').textContent = '0';
                }
            } catch (error) {
                console.error('Flight data error:', error);
                document.getElementById('flight-count').textContent = 'ERR';
            }
        }

        // Initial load
        updateFlights();

        // Update every 30 seconds
        setInterval(updateFlights, 30000);
    </script>
</body>
</html>